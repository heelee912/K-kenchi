<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>K-kenchi â€” ì‹œêµ°êµ¬ ê²½í˜„ì¹˜ ë§µ (ë¶„í•  ë¡œë”© v16b)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', sans-serif; }
  #layout { display: grid; grid-template-columns: 360px 1fr; height: 100vh; }
  #side { border-right: 1px solid #eee; padding: 14px; display: flex; flex-direction: column; gap: 12px; overflow-y: auto; }
  #side h1 { font-size: 18px; margin: 0 0 4px 0; }
  #map { width: 100%; height: 100%; background: #ffffff; }
  .sec { border: 1px solid #eee; border-radius: 10px; padding: 10px; background: #fafafa; }
  .row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
  .btn { padding: 6px 10px; border: 1px solid #ddd; background: white; border-radius: 8px; cursor: pointer; }
  .btn:hover { background: #f0f0f0; }
  .lvbtn { padding: 6px 8px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; background: white; }
  .lvbtn.active { background: #222; color: #fff; }
  .muted { color: #666; font-size: 12px; }
  .sel { font-weight: 700; }
  input[type=text]{ padding:6px; border:1px solid #ddd; border-radius:8px; width:100%; }
  input[type=range]{ width:100%; }
  .stack { display:flex; flex-direction:column; gap:6px; }
  .pill { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #ddd; font-size:12px; }
  @media (max-width: 880px){
    #layout { grid-template-columns: 1fr; grid-template-rows: 360px 1fr; }
    #side { border-right: none; border-bottom: 1px solid #eee; }
  }
</style>
</head>
<body>
<div id="layout">
  <aside id="side">
    <h1>ğŸ‡°ğŸ‡· K-kenchi</h1>

    <div class="sec stack">
      <div class="muted">ì§€ë„ë¥¼ í´ë¦­í•˜ë©´ <b>ì‹œÂ·êµ°Â·êµ¬</b> ë‹¨ìœ„ë¡œ ì„ íƒë©ë‹ˆë‹¤. ì„ íƒ ìœ¤ê³½ì„ ì€ í•´ë‹¹ í´ë¦¬ê³¤ ê²½ê³„ë§Œ ê°•ì¡°í•©ë‹ˆë‹¤.</div>
      <div>ì„ íƒ: <span id="selName" class="sel">ì—†ìŒ</span></div>
      <div class="row">
        <button class="lvbtn" data-level="5">ê±°ì£¼ 5</button>
        <button class="lvbtn" data-level="4">ìˆ™ë°• 4</button>
        <button class="lvbtn" data-level="3">ë°©ë¬¸ 3</button>
        <button class="lvbtn" data-level="2">ì ‘ì§€ 2</button>
        <button class="lvbtn" data-level="1">í†µê³¼ 1</button>
        <button class="lvbtn" data-level="0">ë¯¸ë‹µ 0</button>
      </div>
      <div class="row">
        ë©”ëª¨: <input id="noteBox" placeholder="ì„ íƒ êµ¬ì—­ ë©”ëª¨" />
        <button class="btn" id="btnApplyOne">ì ìš©</button>
      </div>
      <div class="muted">ë¡œë”© ìƒíƒœ: <span id="loadState" class="pill">ëŒ€ê¸°</span></div>
    </div>

    <div class="sec stack">
      <div><b>ê°€ì¤‘ì¹˜(ê³ ì •)</b>: ê±°ì£¼5 Â· ìˆ™ë°•4 Â· ë°©ë¬¸3 Â· ì ‘ì§€2 Â· í†µê³¼1 Â· ë¯¸ë‹µ0</div>
      <div>ì´ì  <b id="sumScore">0</b> Â· ì±„ìš´ ì§€ì—­ <b id="countFilled">0</b></div>
    </div>

    <div class="sec stack">
      <label>ì „ì²´ ë¶ˆíˆ¬ëª…ë„: <span id="opacityVal">50%</span></label>
      <input id="opacitySlider" type="range" min="1" max="100" value="50" />
      <div class="muted">ëª¨ë“  êµ¬ì—­ì— ë™ì¼í•˜ê²Œ ì ìš©ë©ë‹ˆë‹¤.</div>
    </div>

    <div class="sec">
      <div class="row">
        <button class="btn" id="btnExport">JSON ë‚´ë³´ë‚´ê¸°</button>
        <input type="file" id="importJson" accept=".json" style="display:none;">
        <button class="btn" id="btnImport">JSON ë¶ˆëŸ¬ì˜¤ê¸°</button>
      </div>
      <div class="muted">ë°ì´í„°: ì‹œÂ·ë„ë³„ ë¶„í•  GeoJSON</div>
    </div>
  </aside>
  <main id="map"></main>
</div>

<script>
  // ë¶„í•  íŒŒì¼ ëª©ë¡
  const SIDO_FILES = ["data/11_seoul.json", "data/26_busan.json", "data/27_daegu.json", "data/28_incheon.json", "data/29_gwangju.json", "data/30_daejeon.json", "data/31_ulsan.json", "data/36_sejong.json", "data/41_gyeonggi.json", "data/43_chungbuk.json", "data/44_chungnam.json", "data/45_jeonbuk.json", "data/46_jeonnam.json", "data/47_gyeongbuk.json", "data/48_gyeongnam.json", "data/50_jeju.json"];

  const LEVELS = {5:'ê±°ì£¼',4:'ìˆ™ë°•',3:'ë°©ë¬¸',2:'ì ‘ì§€',1:'í†µê³¼',0:'ë¯¸ë‹µ'};
  const weights = {5:5, 4:4, 3:3, 2:2, 1:1, 0:0};

  const SIDO_MAP = {
    '11':'ì„œìš¸íŠ¹ë³„ì‹œ','26':'ë¶€ì‚°ê´‘ì—­ì‹œ','27':'ëŒ€êµ¬ê´‘ì—­ì‹œ','28':'ì¸ì²œê´‘ì—­ì‹œ','29':'ê´‘ì£¼ê´‘ì—­ì‹œ','30':'ëŒ€ì „ê´‘ì—­ì‹œ','31':'ìš¸ì‚°ê´‘ì—­ì‹œ','36':'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ',
    '41':'ê²½ê¸°ë„','42':'ê°•ì›íŠ¹ë³„ìì¹˜ë„','43':'ì¶©ì²­ë¶ë„','44':'ì¶©ì²­ë‚¨ë„','45':'ì „ë¶íŠ¹ë³„ìì¹˜ë„','46':'ì „ë¼ë‚¨ë„','47':'ê²½ìƒë¶ë„','48':'ê²½ìƒë‚¨ë„','50':'ì œì£¼íŠ¹ë³„ìì¹˜ë„'
  };
</script>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  let map = L.map('map', { preferCanvas:true }).setView([36.4, 127.8], 7);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; OpenStreetMap' }).addTo(map);

  let selectedKey=null;

  let dataMap = new Map();          // key=SIG_CD -> {level, notes, name}
  const layerByKey = new Map();     // ëŒ€í‘œ ë ˆì´ì–´
  let globalOpacity = 0.5;

  const $ = (id)=>document.getElementById(id);
  const baseStroke = { weight: 0.7, color: '#777', opacity: 0.9, lineJoin: 'round' };
  const hiStroke   = { weight: 2.2, color: '#111', opacity: 1.0, lineJoin: 'round' };

  function scoreOfLevel(l){ return weights[l] ?? 0; }
  function computeStats(){ let sum=0, filled=0; dataMap.forEach(v=>{ sum+=scoreOfLevel(v.level); if(v.level>0) filled++; }); $('sumScore').textContent=sum; $('countFilled').textContent=filled; }
  function colorFor(v){ if(v<=0) return '#f0f0f0'; const t=Math.max(0,Math.min(1,v/5)); const hue=210-210*t; const light=85-45*t; return `hsl(${hue},70%,${light}%)`; }
  function labelFor(code, sigName){ const sido = SIDO_MAP[(code||'').toString().slice(0,2)] || ''; return (sido? (sido+' '):'') + (sigName||''); }

  function setActive(key){
    if(selectedKey && layerByKey.has(selectedKey)) layerByKey.get(selectedKey).setStyle({ ...baseStroke, fillOpacity: globalOpacity });
    selectedKey=key;
    if(selectedKey && layerByKey.has(selectedKey)){
      const ly=layerByKey.get(selectedKey);
      ly.setStyle({ ...hiStroke, fillOpacity: globalOpacity });
      ly.bringToFront && ly.bringToFront();
    }
  }

  function recolor(){
    layerByKey.forEach((layer,key)=>{
      const rec=dataMap.get(key);
      const val=rec?scoreOfLevel(rec.level):0;
      const fillColor=colorFor(val);
      const isActive=(key===selectedKey);
      const stroke = isActive? hiStroke: baseStroke;
      layer.setStyle({ fillColor, fillOpacity: globalOpacity, ...stroke });
      const tip=[`<b>${rec?rec.name:'êµ¬ì—­'}</b>`, rec?`ë ˆë²¨: ${LEVELS[rec.level]} (${rec.level})`: 'ë ˆë²¨: ë¯¸ì…ë ¥', rec&&rec.notes?`ë©”ëª¨: ${rec.notes}`:''].filter(Boolean).join('<br/>');
      layer.bindTooltip(tip,{sticky:true});
    });
    computeStats();
  }

  function updateButtons(key){ const rec=dataMap.get(key)||{level:0,notes:'',name:''}; document.querySelectorAll('.lvbtn').forEach(b=>b.classList.toggle('active', +b.dataset.level===+rec.level)); $('noteBox').value=rec.notes||''; $('selName').textContent=rec.name||'ì—†ìŒ'; }
  function ensureRec(key, name){ if(!dataMap.has(key)) dataMap.set(key, {level:0,notes:'',name}); else { const o=dataMap.get(key); if(name && !o.name) {o.name=name; dataMap.set(key,o);} } }

  async function loadOne(url){
    const res = await fetch(url);
    if(!res.ok) throw new Error('ë¡œë“œ ì‹¤íŒ¨: '+url);
    const gj = await res.json();
    const layer = L.geoJSON(gj, {
      onEachFeature: (f, layer)=>{
        const code = (f.properties.SIG_CD||'').toString();
        const sig = (f.properties.SIG_KOR_NM||'').toString();
        if(!code || !sig) return;
        layerByKey.set(code, layer);
        const name = labelFor(code, sig);
        ensureRec(code, name);
        layer.on('click', ()=>{ setActive(code); updateButtons(code); });
      },
      style: { ...baseStroke, fillColor:'#f0f0f0', fillOpacity: globalOpacity }
    }).addTo(map);
    try { return layer.getBounds(); } catch(e) { return null; }
  }

  async function loadAll(){
    const badge = $('loadState');
    badge.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
    let overallBounds=null;
    for (const url of SIDO_FILES) {
      try {
        const b = await loadOne(url);
        if (b && b.isValid && b.isValid()) overallBounds = overallBounds ? overallBounds.extend(b) : b;
      } catch(e) { console.error(e); }
    }
    if (overallBounds) map.fitBounds(overallBounds);
    badge.textContent = 'ì™„ë£Œ';
    recolor();
  }

  // Buttons
  document.querySelectorAll('.lvbtn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(!selectedKey) return alert('ë¨¼ì € ì§€ë„ì—ì„œ êµ¬ì—­ì„ ì„ íƒí•˜ì„¸ìš”.');
      const rec=dataMap.get(selectedKey)||{level:0,notes:'',name:''};
      rec.level=Number(btn.dataset.level); dataMap.set(selectedKey, rec);
      updateButtons(selectedKey); recolor();
    });
  });
  $('btnApplyOne').addEventListener('click', ()=>{
    if(!selectedKey) return alert('ë¨¼ì € ì§€ë„ì—ì„œ êµ¬ì—­ì„ ì„ íƒí•˜ì„¸ìš”.');
    const rec=dataMap.get(selectedKey)||{level:0,notes:'',name:''};
    rec.notes=$('noteBox').value.trim(); dataMap.set(selectedKey, rec);
    updateButtons(selectedKey); recolor();
  });

  // Global opacity slider
  const opacitySlider = $('opacitySlider');
  const opacityVal = $('opacityVal');
  function applyOpacity(val){ globalOpacity = Math.max(0.01, Math.min(1, val/100)); opacityVal.textContent = Math.round(globalOpacity*100) + '%'; recolor(); }
  opacitySlider.addEventListener('input', (e)=> applyOpacity(parseInt(e.target.value||'50',10)));
  applyOpacity(parseInt(opacitySlider.value,10));

  // JSON export/import (single file)
  $('btnExport').addEventListener('click', ()=>{
    const compact = Object.fromEntries([...dataMap.entries()].map(([k,v])=>[k,{level:Number(v.level||0),notes:String(v.notes||''),name:String(v.name||'')} ]));
    const obj={data:compact};
    const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='k-kenchi-municipal.json'; a.click(); URL.revokeObjectURL(a.href);
  });
  $('btnImport').addEventListener('click', ()=>$('importJson').click());
  $('importJson').addEventListener('change', (ev)=>{
    const f=ev.target.files[0]; if(!f) return;
    const r=new FileReader();
    r.onload=()=>{
      try{
        const obj=JSON.parse(r.result);
        const data=obj && obj.data && typeof obj.data==='object' ? obj.data : {};
        const next=new Map();
        for (const [k,v] of Object.entries(data)){
          const level = Number((v||{}).level||0);
          const notes = String((v||{}).notes||'');
          const name  = String((v||{}).name||'');
          next.set(String(k), {level,notes,name});
        }
        dataMap = next;
        // name ë³´ì™„: ë ˆì´ì–´ê°€ ë¡œë“œëœ ë’¤ íˆ´íŒì—ì„œ ìë™ ë³´ì™„
        recolor(); alert('ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ: '+dataMap.size+'ê°œ êµ¬ì—­');
      }catch(e){ alert('JSON ì˜¤ë¥˜: '+e); }
    };
    r.readAsText(f);
  });

  // Init
  (function init(){
    map.options.renderer = L.canvas();
    loadAll();
  })();
</script>
</body>
</html>
